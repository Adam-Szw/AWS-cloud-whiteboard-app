package whiteboard_server;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.Socket;
import java.net.URL;
import java.util.ArrayList;

/**
 * Creates client connections.
 * 
 * @author aks60
 * 
 */
public class ClientAccepter implements Runnable {

	private Server server;
	
	private ArrayList<String> serverIPs = new ArrayList<String>();
	
	public ClientAccepter(Server server) {
		this.server = server;
	}
	
	private void removeMyIpFromList() {
		String urlString = "http://checkip.amazonaws.com/";
		URL url;
		try {
			url = new URL(urlString);
			BufferedReader br = new BufferedReader(new InputStreamReader(url.openStream()));
			String IP = br.readLine();
			serverIPs.remove(IP);
		} catch (Exception e) {
			System.out.println("Couldnt connect to amazon website to check IP");
			e.printStackTrace();
		}
	}
	
	@Override
	public void run() {
		removeMyIpFromList();
		while(true) {
			/*
			 * Await client to connect and if received - create new connection execution
			 */
			try {
				Socket connectionSocket = server.serverSocket.accept();
				String receivedIP = connectionSocket.getRemoteSocketAddress().toString();
				receivedIP = receivedIP.substring(1, receivedIP.indexOf(":"));
				server.connectionsLock.lock();
				if(server.connectedServers.contains(receivedIP)) {
					server.connectionsLock.unlock();
					continue;
				}
				if(serverIPs.contains(receivedIP)) {
					if(Server.DEBUG_MODE) System.out.println("New server peer connection established with: " + receivedIP);
					Connection connection = new Connection(server, connectionSocket, true, receivedIP);
					Thread connThread = new Thread(connection);
					connThread.start();
					server.connectedServers.add(receivedIP);
					server.serverConnections.add(connection);
				} else {
					if(Server.DEBUG_MODE) System.out.println("New client connection established with: " + receivedIP);
					Connection connection = new Connection(server, connectionSocket, false, receivedIP);
					Thread connThread = new Thread(connection);
					connThread.start();
					server.clientConnections.add(connection);
				}
				server.connectionsLock.unlock();
			} catch(Exception e){
				System.out.println("Connection error");
				e.printStackTrace();
			} finally {
				Server.sleepThread("Connector thread", Server.UPDATE_TICKRATE);
			}
		}
	}

}
